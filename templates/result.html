{% extends 'base.html' %}
{% block content %}
<!-- Header Section -->
<div class="row mb-4">
	<div class="col-12">
		<h2 class="mb-2 d-flex align-items-center justify-content-between flex-wrap">
			<span class="text-primary fw-bold"><i class="bi bi-clipboard-data"></i> Your Diabetes Risk Analysis</span>
			<form method="post" action="{{ url_for('metrics_route') }}" class="d-inline">
				<button type="submit" class="btn btn-outline-primary">
					<i class="bi bi-speedometer2"></i> Model Accuracy & Metrics
				</button>
			</form>
		</h2>
		<p class="text-secondary mb-0">Comprehensive analysis based on your lifestyle and health factors</p>
	</div>
</div>

{% set score = result.risk_score %}
{% set category = result.risk_category %}
{% set color = 'success' if score <= 35 else ('warning' if score <= 69 else 'danger') %}

<!-- Risk Score & Profile Overview -->
<div class="row g-4 mb-4">
	<!-- Risk Score Card -->
	<div class="col-lg-4">
		<div class="card border-{{ color }} shadow h-100">
			<div class="card-body text-center">
				<h5 class="card-title text-{{ color }}"><i class="bi bi-shield-exclamation"></i> Your Risk Score</h5>
				<p class="display-4 fw-bold text-{{ color }} my-3">{{ score }}%</p>
				<span class="badge bg-{{ color }} fs-6 px-3 py-2">{{ category }}</span>
				
				{% if result.top_factors %}
					<hr class="my-3">
					<div class="text-start">
						<p class="mb-2 fw-semibold text-muted"><i class="bi bi-exclamation-triangle"></i> Top Contributing Factors:</p>
						<ul class="mb-0 small">
							{% for f in result.top_factors %}<li class="mb-1">{{ f }}</li>{% endfor %}
						</ul>
					</div>
				{% endif %}
			</div>
		</div>
	</div>

	<!-- Lifestyle Profile Summary -->
	<div class="col-lg-8">
		<div class="card shadow h-100">
			<div class="card-body">
				<h5 class="card-title text-primary"><i class="bi bi-person-badge"></i> Your Lifestyle Profile</h5>
				
				<!-- Profile Summary Stats -->
				<div class="row g-3 mt-2 mb-3">
					<div class="col-6 col-md-3">
						<div class="text-center p-2 bg-light rounded">
							<i class="bi bi-calendar3 text-primary fs-4"></i>
							<p class="mb-0 small text-muted">Age</p>
							<p class="mb-0 fw-bold">{{ result.inputs.Age }}</p>
						</div>
					</div>
					<div class="col-6 col-md-3">
						<div class="text-center p-2 bg-light rounded">
							<i class="bi bi-gender-ambiguous text-info fs-4"></i>
							<p class="mb-0 small text-muted">Gender</p>
							<p class="mb-0 fw-bold">{{ result.inputs.Gender }}</p>
						</div>
					</div>
					<div class="col-6 col-md-3">
						<div class="text-center p-2 bg-light rounded">
							<i class="bi bi-speedometer text-warning fs-4"></i>
							<p class="mb-0 small text-muted">BMI</p>
							<p class="mb-0 fw-bold">{{ '%.1f'|format(result.inputs.BMI|float) }}</p>
						</div>
					</div>
					<div class="col-6 col-md-3">
						<div class="text-center p-2 bg-light rounded">
							<i class="bi bi-heart-pulse text-danger fs-4"></i>
							<p class="mb-0 small text-muted">Family History</p>
							<p class="mb-0 fw-bold">{{ result.inputs.Family_History }}</p>
						</div>
					</div>
				</div>

				<!-- Lifestyle Factors Grid -->
				<div class="row g-2">
					<div class="col-6 col-md-4">
						<div class="border rounded p-2">
							<small class="text-muted d-block"><i class="bi bi-bicycle"></i> Activity</small>
							<strong class="small">{{ result.inputs.Physical_Activity }}</strong>
						</div>
					</div>
					<div class="col-6 col-md-4">
						<div class="border rounded p-2">
							<small class="text-muted d-block"><i class="bi bi-egg-fried"></i> Diet</small>
							<strong class="small">{{ result.inputs.Diet_Type }}</strong>
						</div>
					</div>
					<div class="col-6 col-md-4">
						<div class="border rounded p-2">
							<small class="text-muted d-block"><i class="bi bi-moon-stars"></i> Sleep</small>
							<strong class="small">{{ result.inputs.Sleep_Quality }}</strong>
						</div>
					</div>
					<div class="col-6 col-md-4">
						<div class="border rounded p-2">
							<small class="text-muted d-block"><i class="bi bi-wind"></i> Stress</small>
							<strong class="small">{{ result.inputs.Stress_Level }}</strong>
						</div>
					</div>
					<div class="col-6 col-md-4">
						<div class="border rounded p-2">
							<small class="text-muted d-block"><i class="bi bi-droplet"></i> Cholesterol</small>
							<strong class="small">{{ result.inputs.Cholesterol_Level }}</strong>
						</div>
					</div>
					<div class="col-6 col-md-4">
						<div class="border rounded p-2">
							<small class="text-muted d-block"><i class="bi bi-activity"></i> BP Status</small>
							<strong class="small">{{ result.inputs.Hypertension }}</strong>
						</div>
					</div>
				</div>

				{% if profile_summary %}
					<div class="alert alert-info mt-3 mb-0">
						<small><i class="bi bi-info-circle"></i> {{ profile_summary }}</small>
					</div>
				{% endif %}
			</div>
		</div>
	</div>
</div>

<!-- Risk Breakdown Chart -->
<div class="row mb-4">
	<div class="col-12">
		<div class="card shadow">
			<div class="card-body">
				<h5 class="card-title text-primary"><i class="bi bi-bar-chart-line"></i> Risk Factor Breakdown</h5>
				<p class="text-muted small mb-3">Individual contribution of each factor to your overall diabetes risk (0-100 scale)</p>
				<div id="risk-chart" style="height: 400px;"></div>
			</div>
		</div>
	</div>
</div>

<!-- AI Recommendations -->
<div class="row mb-4">
	<div class="col-12">
		<div class="card shadow border-primary">
			<div class="card-body">
				<h5 class="card-title text-primary"><i class="bi bi-robot"></i> AI-Powered Recommendations</h5>
				<p class="text-muted small mb-3">Personalized suggestions based on your assessment data</p>
				{% if recommendations %}
					<div class="row g-3">
						{% for r in recommendations %}
						<div class="col-md-6">
							<div class="d-flex align-items-start">
								<i class="bi bi-check-circle-fill text-success me-2 mt-1"></i>
								<div>{{ r }}</div>
							</div>
						</div>
						{% endfor %}
					</div>
				{% else %}
					<div class="alert alert-warning mb-0">
						<i class="bi bi-exclamation-triangle"></i> No recommendations available at the moment.
					</div>
				{% endif %}
			</div>
		</div>
	</div>
</div>

<!-- Model Visualizations -->
{% if viz %}
<div class="row mb-4">
	<div class="col-12">
		<h5 class="text-primary mb-3"><i class="bi bi-graph-up"></i> Model Performance Insights</h5>
	</div>
</div>

<div class="row g-4 mb-4">
	<div class="col-lg-4">
		<div class="card shadow h-100">
			<div class="card-body">
				<h6 class="card-title"><i class="bi bi-grid-3x3"></i> Correlation Heatmap</h6>
				<p class="text-muted small">Feature relationships and correlations</p>
				<img src="{{ viz.plots.correlation_heatmap }}" class="img-fluid rounded" alt="Correlation Heatmap">
			</div>
		</div>
	</div>
	<div class="col-lg-4">
		<div class="card shadow h-100">
			<div class="card-body">
				<h6 class="card-title"><i class="bi bi-stars"></i> Feature Importance</h6>
				<p class="text-muted small">Most influential factors across models</p>
				<img src="{{ viz.plots.feature_importance }}" class="img-fluid rounded" alt="Feature Importance">
			</div>
		</div>
	</div>
	<div class="col-lg-4">
		<div class="card shadow h-100">
			<div class="card-body">
				<h6 class="card-title"><i class="bi bi-trophy"></i> Model Performance</h6>
				<p class="text-muted small">Accuracy comparison across algorithms</p>
				<img src="{{ viz.plots.model_metrics }}" class="img-fluid rounded" alt="Model Metrics">
			</div>
		</div>
	</div>
</div>

<!-- Performance Metrics Table -->
<div class="row mb-4">
	<div class="col-12">
		<div class="card shadow">
			<div class="card-body">
				<h6 class="card-title"><i class="bi bi-table"></i> Detailed Performance Metrics</h6>
				<p class="text-muted small mb-3">Comprehensive evaluation metrics for all models</p>
				<div class="table-responsive">
					<table class="table table-hover table-sm align-middle mb-0">
						<thead class="table-light">
							<tr>
								<th class="fw-bold">Model</th>
								<th class="text-center">Accuracy</th>
								<th class="text-center">Precision</th>
								<th class="text-center">Recall</th>
								<th class="text-center">F1 Score</th>
								<th class="text-center">ROC-AUC</th>
							</tr>
						</thead>
						<tbody>
							{% for name, m in viz.metrics_by_model.items() %}
							<tr>
								<td class="text-uppercase fw-semibold">{{ name }}</td>
								<td class="text-center">{{ '%.3f'|format(m.accuracy) }}</td>
								<td class="text-center">{{ '%.3f'|format(m.precision) }}</td>
								<td class="text-center">{{ '%.3f'|format(m.recall) }}</td>
								<td class="text-center">{{ '%.3f'|format(m.f1) }}</td>
								<td class="text-center">{{ '%.3f'|format(m.roc_auc) }}</td>
							</tr>
							{% endfor %}
						</tbody>
					</table>
				</div>
			</div>
		</div>
	</div>
</div>
{% endif %}

<!-- Action Buttons -->
<div class="row mb-4">
	<div class="col-12 text-center">
		<a href="{{ url_for('assessment') }}" class="btn btn-primary btn-lg me-2">
			<i class="bi bi-arrow-repeat"></i> Take Another Assessment
		</a>
		<a href="{{ url_for('home') }}" class="btn btn-outline-secondary btn-lg">
			<i class="bi bi-house"></i> Back to Home
		</a>
	</div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
	// Get input data from server
	const inputs = {{ result.inputs | tojson | safe }};
	const userRiskScore = {{ score }};
	
	console.log('Inputs:', inputs);
	console.log('User Risk Score:', userRiskScore);
	
	// Risk calculation functions based on medical research
	function calculateBMIRisk(bmi) {
		bmi = Number(bmi);
		if (!bmi || isNaN(bmi)) return { risk: 20, contribution: 0 };
		
		if (bmi < 18.5) {
			return { risk: 15, contribution: 0.02 };
		} else if (bmi >= 18.5 && bmi < 25) {
			return { risk: 10, contribution: 0 };
		} else if (bmi >= 25 && bmi < 30) {
			return { risk: 35, contribution: 0.10 };
		} else if (bmi >= 30 && bmi < 35) {
			return { risk: 60, contribution: 0.25 };
		} else if (bmi >= 35 && bmi < 40) {
			return { risk: 80, contribution: 0.35 };
		} else {
			return { risk: 95, contribution: 0.45 };
		}
	}
	
	function calculateStressRisk(level) {
		const stressMap = {
			'Low': { risk: 10, contribution: -0.03 },
			'Medium': { risk: 45, contribution: 0.05 },
			'High': { risk: 85, contribution: 0.15 }
		};
		return stressMap[String(level)] || { risk: 45, contribution: 0.05 };
	}
	
	function calculateCholesterolRisk(level) {
		const cholMap = {
			'Normal': { risk: 10, contribution: 0 },
			'High': { risk: 70, contribution: 0.15 },
			'Very High': { risk: 90, contribution: 0.15 }
		};
		return cholMap[String(level)] || { risk: 10, contribution: 0 };
	}
	
	function calculateSleepRisk(quality) {
		const sleepMap = {
			'Good': { risk: 10, contribution: -0.05 },
			'Average': { risk: 45, contribution: 0.03 },
			'Poor': { risk: 80, contribution: 0.12 }
		};
		return sleepMap[String(quality)] || { risk: 45, contribution: 0.03 };
	}
	
	function calculateFamilyHistoryRisk(history) {
		const famMap = {
			'No': { risk: 20, contribution: 0 },
			'Yes': { risk: 70, contribution: 0.12 }
		};
		return famMap[String(history)] || { risk: 20, contribution: 0 };
	}
	
	function calculateHypertensionRisk(htn) {
		const htnMap = {
			'No': { risk: 20, contribution: 0 },
			'Yes': { risk: 65, contribution: 0.10 }
		};
		return htnMap[String(htn)] || { risk: 20, contribution: 0 };
	}
	
	function calculateDietRisk(type) {
		const dietMap = {
			'Balanced': { risk: 15, contribution: 0 },
			'Irregular': { risk: 60, contribution: 0.10 },
			'Fast Food': { risk: 75, contribution: 0.10 }
		};
		return dietMap[String(type)] || { risk: 15, contribution: 0 };
	}
	
	function calculateActivityRisk(activity) {
		const activityMap = {
			'High': { risk: 10, contribution: -0.05 },
			'Moderate': { risk: 30, contribution: 0 },
			'Low': { risk: 60, contribution: 0.10 },
			'Sedentary': { risk: 80, contribution: 0.10 }
		};
		return activityMap[String(activity)] || { risk: 30, contribution: 0 };
	}
	
	function calculateAgeRisk(age) {
		age = Number(age);
		if (age >= 30) {
			return { risk: 30, contribution: 0.05 };
		}
		return { risk: 15, contribution: 0 };
	}
	
	// Calculate all risk factors
	const bmiData = calculateBMIRisk(inputs.BMI);
	const stressData = calculateStressRisk(inputs.Stress_Level);
	const cholData = calculateCholesterolRisk(inputs.Cholesterol_Level);
	const sleepData = calculateSleepRisk(inputs.Sleep_Quality);
	const famData = calculateFamilyHistoryRisk(inputs.Family_History);
	const htnData = calculateHypertensionRisk(inputs.Hypertension);
	const dietData = calculateDietRisk(inputs.Diet_Type);
	const activityData = calculateActivityRisk(inputs.Physical_Activity);
	const ageData = calculateAgeRisk(inputs.Age);
	
	// Create chart data
	const categories = ['BMI', 'Stress', 'Cholesterol', 'Sleep', 'Family Hx', 'Hypertension', 'Diet', 'Activity', 'Age'];
	const values = [
		bmiData.risk,
		stressData.risk,
		cholData.risk,
		sleepData.risk,
		famData.risk,
		htnData.risk,
		dietData.risk,
		activityData.risk,
		ageData.risk
	];
	
	const contributions = [
		bmiData.contribution,
		stressData.contribution,
		cholData.contribution,
		sleepData.contribution,
		famData.contribution,
		htnData.contribution,
		dietData.contribution,
		activityData.contribution,
		ageData.contribution
	];
	
	// Color code bars based on risk level
	const barColors = values.map(v => {
		if (v <= 30) return '#198754';
		if (v <= 60) return '#ffc107';
		return '#dc3545';
	});
	
	// Create hover text
	const hoverText = categories.map((cat, i) => {
		const contrib = contributions[i];
		const contribStr = contrib > 0 ? `+${(contrib * 100).toFixed(1)}%` : contrib < 0 ? `${(contrib * 100).toFixed(1)}%` : '0%';
		return `${cat}<br>Risk Level: ${values[i].toFixed(0)}/100<br>Contribution: ${contribStr}`;
	});
	
	const bars = { 
		x: categories, 
		y: values, 
		type: 'bar', 
		name: 'Factor Risk Level', 
		marker: { color: barColors },
		text: values.map(v => v.toFixed(0)),
		textposition: 'outside',
		hovertext: hoverText,
		hoverinfo: 'text'
	};
	
	const riskLine = { 
		x: categories, 
		y: Array(categories.length).fill(userRiskScore), 
		type: 'scatter', 
		mode: 'lines', 
		name: 'Your Overall Risk Score (' + userRiskScore + '%)', 
		line: { color: '#dc3545', width: 3, dash: 'dot' },
		hoverinfo: 'skip'
	};
	
	const layout = { 
		margin: { t: 40, r: 20, b: 80, l: 60 }, 
		yaxis: { 
			range: [0, 100], 
			title: 'Risk Level (0-100)',
			gridcolor: '#e9ecef'
		},
		xaxis: {
			tickangle: -45
		},
		plot_bgcolor: '#f8f9fa',
		paper_bgcolor: 'white',
		showlegend: true,
		legend: {
			x: 0.5,
			y: 1.15,
			xanchor: 'center',
			orientation: 'h'
		}
	};
	
	// Create the plot
	Plotly.newPlot('risk-chart', [bars, riskLine], layout, { displayModeBar: false, responsive: true });
	
	// Log contributions
	const totalContribution = contributions.reduce((sum, c) => sum + c, 0);
	console.log('Total Risk Contribution:', (totalContribution * 100).toFixed(1) + '%');
	console.log('Individual Contributions:', contributions.map((c, i) => `${categories[i]}: ${(c * 100).toFixed(1)}%`));
});
</script>
{% endblock %}